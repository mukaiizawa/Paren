Paren言語仕様書

この資料はParenの仕様を定義する。

# 基本概念
ParenはCommon Lisp、Scheme、Arc等のLisp系の言語を参考に、
より、簡潔に記述できるよう設計したプログラミング言語である。
Common Lispのように強力なマクロの機能を備える。
Parenは次のコンセプトで作られた。
- 簡潔
逆に、次のような項目は全く考慮しない。
- 実行速度
- 巨大プロジェクトでの使用
- 健全なマクロ

# S式
Parenはアトムまたはリストにより記述される。
この記述をS式と呼ぶ。
S式は評価されるとS式を返す。

# メタ言語
Parenの文法を以下のEBNF表記で定義する。
    x? -- xは省略可能。
    . -- 任意の一文字
    x* -- xの零回以上の繰り返し。
    x+ -- xの一回以上の繰り返し。
    (x | y) -- xまたはy。
    'x' -- 固定字句。文字の並びxを示す。xは複数の場合もある。
    [...] -- 文字グループ。[]内で指定された文字の何れか。
             x-yと表記された場合はxとyの間の何れかを表す。
             先頭に~を指定した場合は[]内で指定された文字以外の何れかを示す。
    = -- 定義。左辺で示される構文要素を右辺で定義される。
## 注意事項
メタ言語内で、可読性のため空白を挿入することがある。
その空白はメタ言語において無視されるものとする。
固定字句及び文字グループ中で`\`を記述した場合、後続する文字そのものを意味する。
ただし、`\t`及び`\n`はそれぞれタブ文字、改行文字を意味するものとする。

# 字句規則
字句規則はリードマクロの展開前と展開後で異なる。
ここではリードマクロ展開後の字句規則について述べる。
## 字句の区切り(separator)
    separator = space | comment
プログラムは空白又はコメントにより区切られる。
これらは要素の区切りとして使用される以外は無視される。
### 空白(space)
    space = [\t\n ]
空白はタブ文字、改行文字、半角スペースである。
### コメント(comment)
    comment = (line_comment | block_comment | paren_document)
    line_comment = ';' [^\n]*
    block_comment = '#|' '|#'* '|#'
    paren_document = '#||' '|#'* '|#'
コメントは一行コメントとブロックコメントの二種類存在する。
一行コメントは`;`から行末までである。
ブロックコメントは`#|`で始まり`|#`で囲まれた領域である。
ただし、ブロックコメントをネストすることはできない。
また、ブロックコメントの開始を`#||`にすると、
そのブロックコメントは後述するParenドキュメントとして抽出される。
## S式(s_expr)
    s_expr = list | atom
S式はリストまたはアトムである。
### リスト(list)
    list = '(' (s_expr (separator s_expr)*)* ')'
リストは零以上のS式を括弧`(`、`)`で括ったものである。
要素がないリストは空のリストと呼び、
セマンティックス上は後述するキーワード`:nil`と等価である。
### アトム(atom)
    atom = (symbol | keyword | number | string | map | array)
atomは次の字句で構成される。
- シンボル
- キーワード
- 数値
- 文字
- 文字列
- マップ
- 配列
#### シンボル(symbol)
    symbol = identifier
    identifier = (identifier_first identifier_rest)
    identifier_first = [!$%&*+\-/<=>?a-zA-Z^_|.]
    identifier_rest = (identifier_first | ["#',0-9\[\]`{}~])*
識別子は一部の記号及び数字を除く文字から始まり、
ほとんどすべてのascii文字が任意の数続く。
ただし、上記の条件を満たす識別子のうち、
後述する数値と見做せるトークンに限り数値と見做す。
#### キーワード(keyword)
    keyword = ':' identifier
キーワードは識別子の前に`:`を付けたものである。
#### 数値(number)
    number = [+-]? [0-9]+ ('.' [0-9]+)?
Parenでは指数表記等はサポートしない。
処理の簡潔化のため、`001`等も数字と見做し、`1`と評価する。
#### 文字列(string)
    string = '"' (. | esc)* '"'
    esc = '\\' .
文字列はダブルクォートで囲まれた任意の文字の列である。
エスケープシーケンスは'\'から始まり次の一文字によりその意味が異なる。
- n: 改行
- t: 水平タブ
- それ以外の文字: その文字そのもの

# リードマクロ
リードマクロはParenの読み込み時に展開される。
展開結果にリードマクロが含まれる場合は再帰的に展開される。
## バッククォート(quote)
    backquote = '`' s_expr
    => (quote s_expr)
バッククォートはS式の前に`\``を付けたものである。
展開結果はスペシャルフォーム`quote`で囲まれる。
この展開を`s_expr`をクォートする。乃至、`s_expr`がクォートされるという。
## チルダ(tilde)
    tilde = '~' s_expr
チルダはその後に読み込まれるS式内に、
後述するカンマまたは、カンマアットが含まれている場合を除き、
バッククォートと同じ振る舞いをする。
## カンマ(comma)
カンマはチルダ内でのみ使用でき、
外で使用した場合はエラーとなる。
チルダ内のフォームは評価対象外となるが、
その中のカンマ内のフォームを評価対象にする。
この展開をアンクォートするという。
評価例を示す。
    ~(list 1 `,(list 2 3))
    => (list 1 `(2 3))
## カンマアット(comma_at)
カンマアットリードマクロは評価結果を、
外側のListに結合させる点を除き、
カンマリードマクロと同じである。
評価例を示す。
    ~(list 1 ,@(list 2 3))
    => (list 1 2 3)
## 配列(array)
    array = '[' s_expr* ']'
    => (array s_expr)
配列は鍵括弧`[`、`]`で囲まれたS式である。
展開後は、配列を生成するS式となる。
## マップ(map)
    map = '{' (s_expr s_expr)* '}'
    => (map s_expr)
マップは括弧`{`、`}`で囲まれたS式の対である。
展開後は、マップを生成するS式となる。

# 構文規則
前述したように、ParenはS式によって記述される。
強力なマクロがあるためParenには構文があってないようなものである。
ここでは形式的な記述はせず、
組み込みのスペシャルフォーム、マクロ、関数について説明する。
# スペシャルフォーム
スペシャルフォームはParenのS式の評価ルールに従わない、
フォームごとに異なる特別なルールで評価される。
スペシャルフォームには次の種類が存在する。
- <-
- let
- if
- progn
- quote
- fn
## <-(代入)
    <- = '(<-' assign_args* ')'
    assign_args = symbol s_expr
`<-`は現在の環境から最も近い環境に存在する変数に値を代入する。
代入対象の変数が環境から見つからない場合は、
現在の環境に対象変数を登録し、値を設定する。
引数の数は偶数でなければならない。
左から順に2n番目の変数に2n + 1番目の値を代入される。
評価結果はそれ以降の評価に干渉する。
フォームは最後に評価(代入)された値を返す。
## let(変数束縛)
    let = '(let' '(' let_form+ ')'
              s_expr* ')'
    let_form = '(' symbol s_expr ')' | symbol | nil
`let`は新しく変数を束縛する。
束縛する変数が既に宣言されていても構わない。
第一引数が変数束縛フォームのリストを表す。
変数束縛フォームがシンボルの場合は
第二引数以降が、第一引数で束縛した変数の環境下にて暗黙のprognにより評価される。
## progn(逐次実行)
    '(progn' s_expr+ ')'
prognは引数のフォームを左から順に評価していき、
最後のフォームの評価結果を返す。
## if(条件分岐)
    (if (< n 0) -1
        (= n 0) 0
        1)
`if`は条件分岐を実現するスペシャルフォームである。
第一引数の評価結果が真の場合は第二引数を、
そうでなければ第三引数の評価結果が真の場合は…
のように評価される。
C言語系の条件分岐との比較イメージを示す。
    if (n < 0) return -1;
    else if (n = 0) return 0;
    else return 1;
## quote(クォート)
    (quote expr)
`quote`はS式`expr`の評価を見送り、`expr`そのものを返す。
その利用頻度から構文糖であるリードマクロ`\``が定義されている。
## fn(無名関数)
    (fn (args) body)
`fn`は関数を生成する。
第一引数`args`が仮引数のリストである。
呼び出し時に実引数に束縛される。
    ((fn (x y z) (* (+ x y) z)) 1 2 3)
    => 9
`args`は関数の仮引数で、次のパラメーターを指定することができる。
1. 必須パラメーター
2. オプショナルパラメーター
3. レストパラメーター
4. キーワードパラメーター
すべてのパラメーターを同時に組み合わせて指定することができるが、
その順番は上のとおりに指定しなければならない。
### 必須パラメーター
    (fn (x y z) body)
必須パラメーターはsymbolのリストである。
指定したパラメーターは必須となり、
関数呼び出し時に実引数が足りない場合はエラーとなる。
### オプショナルパラメーター
    (fn (x ? y1 y2 z1 z2) body)
オプショナルパラメーターは実引数が渡されなかった場合は指定された初期値を用いる。
`?`の後の引数はオプショナルパラメーターと見做される。
オプショナルパラメーターは名称と初期値を対で指定する必要がある。
上の例では、`y1`、`z1`がオプショナルパラメーター名で、
その値の初期値がそれぞれ`y2`、`x2`となる。
オプショナルパラメーターを指定した関数は、
実引数の数が少ない場合に初期値が使用される。
### レストパラメーター
    (fn (x . y) body)
引数のリストに`.`が出現した場合はその次の値をレストパラメーターとする。
仮引数よりも余分な実引数がリストとして実行時にレストパラメーターに束縛される。
### キーワードパラメーター
    (fn (x :key1 val1 :key2 val2) body)
引数のリストにキーワードが出現した場合は、
その直後の値が対となるキーワードパラメーターと見做される。

# マクロ
マクロはParenが読み込まれ、リードマクロが展開された後に実行される。
この実行をマクロ展開という。
マクロはリードマクロ、マクロ、スペシャルフォーム、 関数等、
ほぼすべてのParenの機能を使用してユーザが定義することができる。
マクロは使用される前に定義がされている必要がある。
マクロ展開は、展開結果にマクロが含まれなくなるまで再帰的に行われる。
展開結果がParenの文法に従っていればよいため、
展開前のフォームはしばしばParenの文法に従わない。
## 組み込みマクロ
comming soon.

# 関数
comming soon.

# Parenドキュメント
Parenドキュメントは`#||`と`|#`で囲まれた範囲内の文字列を、
html形式で出力する機能である。
Parenのソースコード一ファイルにつき、
そのファイルの拡張子がhtmlであるようなドキュメントが一ファイル生成される。
Parenドキュメントの文法はマークダウン形式とする。
ただし、行頭の`|`無視される。
次の対象にはParenドキュメントを明示的に作成すべきである。
- モジュールファイルそのもの
- マクロ
- 変数
- 関数
例として関数のParenドキュメントを示す。
    #||
     | # Function list
     | ## Syntax
     |     list . objects => list
     | ## Description
     | list returns a list containing the supplied objects.
     | ## Arguments
     |     objects --- a object list. 
     | ## Value
     |     list --- a list containing the supplied object.
     | ## Examples
     | ## Side Effects
     | ## Exceptional Situations
     | ## See Also
     |     [cons](core.html#cons).
     |#
    (defun list (. args) args)
一行目は見出しレベル最大で記述対象を明記する。
Parenドキュメントを記載する場合は必要に応じて次の項目を使用する。
- Syntax
- Description
- Arguments
- Value
- Examples
- Side Effects
- Exceptional Situations
- See Also
## Syntax
構文を記述する。
また、評価結果を`=>`の後に記載する。
## Description
ドキュメント対象についての情報をできるだけ詳細に記載する。
## Arguments
仮引数の仕様を記述する。
## Value
評価結果について記述する。
## Examples
使用例を記載する。
## Side Effects
副作用がある場合に明記する。
## Side Effects
副作用がある場合は明記する。
## Exceptional Situations
例外が発生しうる場合は個々に明記する。
## See Also
参照ページがある場合はここにリンクを記述する。
